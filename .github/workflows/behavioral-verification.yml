name: Behavioral Parity Verification

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  verify-critical:
    name: Verify Critical Transcripts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run critical transcript verification
        run: npm run verify:transcripts -- --priority critical
        continue-on-error: true
      
      - name: Upload critical results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: critical-verification-results
          path: .kiro/testing/transcript-verification-summary.json
          if-no-files-found: ignore

  verify-all:
    name: Verify All Transcripts (PR only)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run all transcript verification
        run: npm run verify:transcripts
        continue-on-error: true
      
      - name: Generate HTML report
        if: always()
        run: npm run verify:report
      
      - name: Upload verification results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: all-verification-results
          path: |
            .kiro/testing/transcript-verification-summary.json
            .kiro/testing/verification-report.html
          if-no-files-found: ignore
      
      - name: Comment PR with results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            try {
              const summaryPath = path.join('.kiro', 'testing', 'transcript-verification-summary.json');
              if (!fs.existsSync(summaryPath)) {
                console.log('Summary file not found');
                return;
              }
              
              const summary = JSON.parse(fs.readFileSync(summaryPath, 'utf-8'));
              
              const passRate = (summary.overallPassRate * 100).toFixed(1);
              const avgSimilarity = (summary.averageSimilarity * 100).toFixed(1);
              
              const body = `## ðŸŽ® Behavioral Parity Verification Results
              
              **Overall Results:**
              - Pass Rate: ${passRate}% (${summary.passedTranscripts}/${summary.totalTranscripts} transcripts)
              - Average Similarity: ${avgSimilarity}%
              - Commands Tested: ${summary.totalCommands}
              - Commands Matched: ${summary.matchedCommands}
              - Execution Time: ${(summary.executionTime / 1000).toFixed(2)}s
              
              **By Priority:**
              ${Object.entries(summary.byPriority).map(([priority, stats]) => 
                `- **${priority}**: ${stats.passed}/${stats.total} (${(stats.passRate * 100).toFixed(1)}%)`
              ).join('\n')}
              
              ${summary.failedTranscripts > 0 ? `
              **Failed Transcripts:**
              ${summary.results.filter(r => !r.passed).map(r => 
                `- ${r.name} (${r.category}/${r.priority}): ${r.matchedCommands}/${r.totalCommands} commands`
              ).join('\n')}
              ` : 'âœ… All transcripts passed!'}
              
              [View detailed HTML report in artifacts]
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } catch (error) {
              console.error('Error posting comment:', error);
            }

  verify-puzzles:
    name: Verify Puzzle Solutions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run puzzle verification tests
        run: npm run verify:puzzles
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: puzzle-verification-results
          path: |
            coverage/
            test-results/
          if-no-files-found: ignore
